name: Traceability Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issues:
    types: [opened, edited]
  workflow_dispatch:  # Allow manual trigger

jobs:
  validate-traceability:
    runs-on: ubuntu-latest
    permissions:
      issues: read
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests pyyaml
      
      - name: Check for orphaned requirements
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/github-orphan-check.py || {
            echo "\u26a0\ufe0f Orphan check needs GitHub Issues to be created first"
            echo "See docs/QUICK-START-github-issues.md for issue creation workflow"
            exit 0
          }
        continue-on-error: true
        id: orphan-check
      
      - name: Generate traceability report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p reports
          python scripts/github-traceability-report.py > reports/traceability.md || {
            echo "# Traceability Report" > reports/traceability.md
            echo "" >> reports/traceability.md
            echo "## Status: GitHub Issues Setup Required" >> reports/traceability.md
            echo "" >> reports/traceability.md
            echo "Traceability tracking via GitHub Issues is configured but no issues exist yet." >> reports/traceability.md
            echo "" >> reports/traceability.md
            echo "Next Steps:" >> reports/traceability.md
            echo "1. Create issues using templates in .github/ISSUE_TEMPLATE/" >> reports/traceability.md
            echo "2. Link issues using 'Traces to: #N' syntax" >> reports/traceability.md
            echo "3. See docs/QUICK-START-github-issues.md for guidance" >> reports/traceability.md
          }
      
      - name: Upload traceability report
        uses: actions/upload-artifact@v4
        with:
          name: traceability-report
          path: reports/traceability.md
          retention-days: 30
      
      - name: Comment on PR with report summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('reports/traceability.md', 'utf8');
            
            // Extract summary section
            const summaryMatch = report.match(/## Summary\n([\s\S]*?)##/);
            const summary = summaryMatch ? summaryMatch[1] : 'Summary not available';
            
            const comment = `## ğŸ“Š Traceability Report
            
            ${summary}
            
            ğŸ“ Full report available in workflow artifacts.
            
            [View detailed traceability matrix](../actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Check orphan results
        if: steps.orphan-check.outcome == 'failure'
        run: |
          echo "âŒ Orphaned requirements detected!"
          echo "Please link all requirements to parent issues."
          exit 1
